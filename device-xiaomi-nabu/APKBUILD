# Reference: <https://postmarketos.org/devicepkg>
pkgname=device-xiaomi-nabu
pkgdesc="Xiaomi Pad 5"
pkgver=0.2
pkgrel=0
url="https://postmarketos.org"
license="MIT"
arch="aarch64"
options="!check !archcheck"
depends="
	linux-postmarketos-qcom-sm8150-nabu
	make-dynpart-mappings
    mesa-vulkan-freedreno
	mesa-dri-gallium
	mkbootimg
	postmarketos-base
    swclock-offset
"
makedepends="devicepkg-dev"
source="
	deviceinfo
	30-gpu-firmware.files
"

subpackages="
	$pkgname-nonfree-firmware:nonfree_firmware
	$pkgname-mainline-firmware:mainline_firmware
"

build() {
	devicepkg_build $startdir $pkgname
}

package() {
	devicepkg_package $startdir $pkgname
}

mainline_firmware() {
	pkgdesc="Firmware support packages for mainline kernel"
	depends="firmware-xiaomi-nabu-adreno"
	install_if="linux-postmarketos-qcom-sm8150-nabu $pkgname-nonfree-firmware"
	mkdir "$subpkgdir"

	install -Dm644 "$srcdir/30-gpu-firmware.files" \
		"$subpkgdir/usr/share/mkinitfs/files/30-gpu-firmware.files"
}

nonfree_firmware() {
	pkgdesc="Firmware for GPU, Touschreen, Audio, Bluetooth, WiFi, etc."
	depends="
		firmware-xiaomi-nabu-adreno
		firmware-xiaomi-nabu-adsp
		firmware-xiaomi-nabu-cdsp
        firmware-xiaomi-nabu-cirrus
		firmware-xiaomi-nabu-modem
		firmware-xiaomi-nabu-wlan
		firmware-xiaomi-nabu-venus
		firmware-xiaomi-nabu-touchscreen
        linux-firmware-qca
        msm-modem
		pd-mapper
		tqftpserv
		"
	install="$subpkgname.post-install"
	mkdir "$subpkgdir"
}

sha512sums="
e4cb6449127d43eb8b6dee533fb4000f04bd7653e79902bbaab4fe9dc3d4a978c8bca6895d0debf61392dedb07334ff3d5d7e1c852e3a9cea6701467c703586b  deviceinfo
ed5788faaa0b70b0fd1d7702ce9e1991749aae4226ae1aac12c73c705541880c8fd7715b3da1abbdb8b0e469081744e92822e0ec3f56ad0160405a6fdfac5806  30-gpu-firmware.files
"
